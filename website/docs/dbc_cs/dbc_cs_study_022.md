# ç¬¬22ç«  ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒªãƒ³ã‚°è¶…å…¥é–€ï¼šåˆ†é¡ã—ã¦å¢ƒç•Œã§å¤‰æ›ã™ã‚‹ğŸ§©ğŸ§ 

## ã“ã®ç« ã§ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ğŸ¯âœ¨

* ã‚¨ãƒ©ãƒ¼ã‚’ã€Œç¨®é¡ã€ã§åˆ†ã‘ã¦ã€è¿·ã‚ãšæ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ğŸ§ ğŸ§©
* ã€Œä¾‹å¤–ã«ã™ã‚‹ï¼ŸResultã§è¿”ã™ï¼Ÿã€ã‚’ç­‹ã®ã„ã„åŸºæº–ã§æ±ºã‚ã‚‰ã‚Œã‚‹âš–ï¸ğŸ­
* å¢ƒç•Œï¼ˆAPI/ç”»é¢/å¤–éƒ¨I/Fï¼‰ã§ã€ã‚¨ãƒ©ãƒ¼ã‚’ã¡ã‚ƒã‚“ã¨â€œç¿»è¨³â€ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ğŸŒğŸ”
* ASP.NET Coreã® Problem Detailsï¼ˆæ¨™æº–ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰ã«ãã‚Œã„ã«å¤‰æ›ã§ãã‚‹ğŸ“¦ğŸ§¾

---

## 1. ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã£ã¦ãªã«ï¼ŸğŸ¤”ğŸ’¡

ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã¯ã€ã€Œå¤±æ•—ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ã‚’å…ˆã«æ•´ç†ã—ã¦ã€**å®Ÿè£…ã¨è¿”ã—æ–¹ï¼ˆè¦‹ã›æ–¹ï¼‰ã‚’æƒãˆã‚‹**ã“ã¨ã ã‚ˆã€œğŸ§©âœ¨

ãŸã¨ãˆã°åŒã˜â€œå¤±æ•—â€ã§ã‚‚â€¦

* å…¥åŠ›ãƒŸã‚¹ï¼ˆãƒ¡ãƒ¼ãƒ«å½¢å¼ãŒå¤‰ï¼‰ğŸ“§ğŸ’¦ â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç›´ã›ã‚‹
* åœ¨åº«åˆ‡ã‚Œï¼ˆæ³¨æ–‡ã§ããªã„ï¼‰ğŸ“¦ğŸ˜¢ â†’ ä»•æ§˜ã¨ã—ã¦èµ·ã“ã‚Šã†ã‚‹
* DBæ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆå¤–éƒ¨è¦å› ï¼‰â³ğŸŒ©ï¸ â†’ å†è©¦è¡Œã—ãŸã‚‰ç›´ã‚‹ã‹ã‚‚
* nullãŒæ¥ãŸï¼ˆå‘¼ã³æ–¹ãŒé–“é•ã„ï¼‰ğŸ§¨ â†’ é–‹ç™ºè€…ãŒç›´ã™ãƒã‚°

ã“ã‚Œã‚’**ã”ã¡ã‚ƒæ··ãœ**ã«ã™ã‚‹ã¨ã€å‘¼ã³å‡ºã—å´ãŒã€Œã©ã†å¯¾å‡¦ã™ã‚Œã°ã„ã„ã®â€¦ğŸ˜µã€ã£ã¦ãªã‚‹ã®ãŒäº‹æ•…ã®ã¯ã˜ã¾ã‚ŠğŸ’¥

---

## 2. ã¾ãšã¯â€œåˆ†é¡â€ãŒã™ã¹ã¦ğŸ—‚ï¸ğŸ·ï¸

### 2.1 ã„ã¡ã°ã‚“å¼·ã„åˆ†é¡ï¼šèª°ãŒç›´ã›ã‚‹ï¼ŸğŸ‘¤ğŸ”§

* **å¥‘ç´„é•åï¼ˆãƒã‚°ï¼‰**ğŸ§¨ğŸ‘©â€ğŸ’»
  å‘¼ã³å‡ºã—æ–¹ãƒ»ä½¿ã„æ–¹ãŒé–“é•ã„ã€‚ç›´ã™ã®ã¯é–‹ç™ºè€…ã€‚
  â†’ åŸºæœ¬ã¯ **ä¾‹å¤–ï¼ˆfail fastï¼‰** ãŒåˆã†ğŸ’¥
* **æ¥­å‹™ã‚¨ãƒ©ãƒ¼ï¼ˆä»•æ§˜ï¼‰**ğŸ“©ğŸ™‚
  å…¥åŠ›ãƒŸã‚¹ / åœ¨åº«åˆ‡ã‚Œ / æ¨©é™ãªã— ãªã©ã€Œèµ·ãã‚‹å‰æã€ã€‚
  â†’ åŸºæœ¬ã¯ **Resultï¼ˆå¤±æ•—ã‚’å€¤ã§è¿”ã™ï¼‰** ãŒåˆã†ğŸ
* **ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ï¼ˆé‹ç”¨ãƒ»å¤–éƒ¨è¦å› ï¼‰**ğŸŒ©ï¸ğŸ–¥ï¸
  DB/ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/å¤–éƒ¨APIãªã©ã€‚
  â†’ ä¾‹å¤–ã§ã‚‚Resultã§ã‚‚OKã ã‘ã©ã€**å¢ƒç•Œã§å¿…ãšæ•´ç†ã—ã¦è¿”ã™**ã®ãŒå¤§äº‹ğŸ”âœ¨

```mermaid
flowchart TD
    Problem[å•é¡Œç™ºç”Ÿ!] --> Q{èª°ãŒç›´ã›ã‚‹?}
    Q -- é–‹ç™ºè€… (ãƒã‚°) --> Exc[ä¾‹å¤– Exception<br/>Fail Fast!]
    Q -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ (ä»•æ§˜) --> Res[Resultå‹<br/>é¸æŠè‚¢ã‚’æç¤º]
    Q -- é‹ç”¨/å¤–éƒ¨ (ã‚·ã‚¹ãƒ†ãƒ ) --> Sys[ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰/ãƒªãƒˆãƒ©ã‚¤<br/>å¢ƒç•Œã§æ•´ãˆã‚‹]
    
    style Exc fill:#f8bbd0,stroke:#c2185b
    style Res fill:#fff9c4,stroke:#fbc02d
    style Sys fill:#e1f5fe,stroke:#01579b
```

---

### 2.2 ã‚‚ã†1ã¤ã®è»¸ï¼šå†è©¦è¡Œã§ãã‚‹ï¼ŸğŸ”â³

åŒã˜å¤±æ•—ã§ã‚‚ã€Œå¯¾å‡¦ã€ãŒå¤‰ã‚ã‚‹ã‹ã‚‰ã€ãƒ©ãƒ™ãƒ«ã‚’ä»˜ã‘ã¦ãŠãã¨è¶…ãƒ©ã‚¯ğŸ·ï¸âœ¨

| ç¨®é¡       | ä¾‹             | å†è©¦è¡Œ | å…¸å‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
| -------- | ------------- | --: | ------- |
| å…¥åŠ›ãƒ»æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ | æ–‡å­—æ•°ã‚ªãƒ¼ãƒãƒ¼ã€å½¢å¼é•å  |   âŒ | å…¥åŠ›ã‚’ç›´ã™âœï¸ |
| æ¥­å‹™ãƒ«ãƒ¼ãƒ«é•å  | åœ¨åº«åˆ‡ã‚Œã€ä¸Šé™è¶…ãˆ     | âŒ/â–³ | åˆ¥æ¡ˆã‚’æç¤ºğŸ”„ |
| ä¸€æ™‚çš„éšœå®³    | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€503    |   âœ… | ãƒªãƒˆãƒ©ã‚¤ğŸ”  |
| ãƒã‚°ï¼ˆå¥‘ç´„é•åï¼‰ | nullæ¸¡ã—ã€çŠ¶æ…‹é·ç§»ãƒŸã‚¹ |   âŒ | ç›´ã™ğŸ› ï¸   |

---

## 3. C#ã§ã®è¡¨ç¾ï¼šä¾‹å¤– vs Result ğŸ­âš–ï¸

### 3.1 ä¾‹å¤–ã«å‘ã„ã¦ã‚‹ã‚‚ã®ğŸ’¥

* **å¥‘ç´„é•åï¼ˆãƒã‚°ï¼‰**ï¼šå¼•æ•°ãŒnullãªã®ã«ãƒ€ãƒ¡ãªè¨­è¨ˆã€ç¯„å›²å¤–ã€å†…éƒ¨ä¸å¤‰æ¡ä»¶ãŒå´©ã‚ŒãŸâ€¦ãªã©ğŸ§¨
* **ãã®å ´ã§å›å¾©ä¸èƒ½**ï¼šç¶šè¡Œã—ãŸã‚‰ãƒ‡ãƒ¼ã‚¿ç ´å£Šã®å¯èƒ½æ€§ãŒã‚ã‚‹æ™‚ğŸ§¯

âœ… ä¾‹å¤–ã«ã™ã‚‹ãªã‚‰ã€Œå‹ã€ã¨ã€Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ã‚’ä¸å¯§ã«ã™ã‚‹ã¨ã€ãƒ‡ãƒãƒƒã‚°ãŒé€Ÿã„ã‚ˆã€œğŸƒâ€â™€ï¸ğŸ’¨

---

### 3.2 Resultã«å‘ã„ã¦ã‚‹ã‚‚ã®ğŸ

* **æ¥­å‹™ã‚¨ãƒ©ãƒ¼ï¼ˆä»•æ§˜ï¼‰**ï¼šèµ·ã“ã‚‹ã“ã¨ãŒå‰æã§ã€å‘¼ã³å‡ºã—å´ãŒåˆ†å²ã—ã¦å¯¾å‡¦ã§ãã‚‹ã‚‚ã®ğŸ™‚ğŸ“©
* ã€ŒNotFoundã€ã€ŒConflictã€ã€ŒValidationã€ã¿ãŸã„ãª â€œã‚ˆãã‚ã‚‹å¤±æ•—ã‚«ãƒ†ã‚´ãƒªâ€ğŸ§©

Resultã«ã™ã‚‹ã¨ã€å‘¼ã³å‡ºã—å´ãŒã“ã†æ›¸ã‘ã‚‹ã®ãŒå¼·ã„ğŸ‘‡âœ¨
ã€ŒæˆåŠŸãªã‚‰é€²ã‚€ã€å¤±æ•—ãªã‚‰ã‚¨ãƒ©ãƒ¼å†…å®¹ã‚’è¦‹ã¦è¿”ã™ã€

---

## 4. æœ€å°æ§‹æˆã®ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒ«ï¼ˆã¾ãšã¯ã“ã‚Œã§OKï¼‰ğŸ§±âœ¨

ã“ã“ã‹ã‚‰ã¯ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆä¸­èº«ï¼‰ã€ãŒè¿”ã™ã‚¨ãƒ©ãƒ¼ã‚’ **DomainError** ã¨ã—ã¦æƒãˆã‚‹ã‚ˆğŸ§©

### 4.1 DomainErrorã®å‹ã‚’ä½œã‚‹ğŸ—ï¸

```csharp
namespace Sample.Errors;

public abstract record DomainError(string Code, string Message)
{
    public virtual bool IsRetryable => false;
}

public sealed record ValidationError(string Code, string Message, string? Target = null)
    : DomainError(Code, Message);

public sealed record NotFoundError(string Code, string Message)
    : DomainError(Code, Message);

public sealed record ConflictError(string Code, string Message)
    : DomainError(Code, Message);

public sealed record ForbiddenError(string Code, string Message)
    : DomainError(Code, Message);

public sealed record ExternalDependencyError(string Code, string Message, bool Retryable)
    : DomainError(Code, Message)
{
    public override bool IsRetryable => Retryable;
}
```

ãƒã‚¤ãƒ³ãƒˆğŸ’¡

* **Code**ï¼šæ©Ÿæ¢°çš„ã«æ‰±ãˆã‚‹ï¼ˆãƒ­ã‚°é›†è¨ˆãƒ»UIåˆ†å²ã«ä¾¿åˆ©ï¼‰ğŸ·ï¸
* **Message**ï¼šäººãŒèª­ã‚€ç”¨ï¼ˆãŸã ã—å†…éƒ¨æƒ…å ±ã¯å‡ºã—ã™ããªã„ï¼‰ğŸ™ˆ

---

### 4.2 Resultå‹ï¼ˆæˆåŠŸ/å¤±æ•—ã®ç®±ï¼‰ğŸ“¦âœ¨

```csharp
namespace Sample.Results;

using Sample.Errors;

public readonly record struct Result<T>(T? Value, DomainError? Error)
{
    public bool IsSuccess => Error is null;

    public static Result<T> Ok(T value) => new(value, null);
    public static Result<T> Fail(DomainError error) => new(default, error);

    public TResult Match<TResult>(Func<T, TResult> onOk, Func<DomainError, TResult> onFail)
        => IsSuccess ? onOk(Value!) : onFail(Error!);
}
```

---

## 5. â€œå¢ƒç•Œã§å¤‰æ›â€ãŒã“ã®ç« ã®ä¸»å½¹ğŸšªğŸ”ğŸŒˆ

![ã‚¨ãƒ©ãƒ¼ã®ç¿»è¨³ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’HTTPã‚„UIã«å¤‰æ›ã™ã‚‹](./picture/dbc_cs_study_022_error_mapping.png)

### 5.1 å¢ƒç•Œã£ã¦ã©ã“ï¼ŸğŸšª

* Web APIã®å…¥å£ï¼ˆController / Minimal APIï¼‰ğŸŒ
* UIï¼ˆç”»é¢ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ğŸ–¥ï¸
* å¤–éƒ¨APIå‘¼ã³å‡ºã—ã®å…¥å£/å‡ºå£ğŸ”Œ

å¢ƒç•Œã®å½¹ç›®ã¯ã“ã‚ŒğŸ‘‡âœ¨
**ä¸­ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰ã®è¡¨ç¾ã‚’ã€å¤–ï¼ˆHTTP/ç”»é¢/ä»–ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã®è¡¨ç¾ã«ç¿»è¨³ã™ã‚‹**ğŸ—£ï¸â¡ï¸ğŸŒ
ã“ã®åˆ†é›¢ãŒã€ã‚ã¨ã‹ã‚‰å¢—ãˆã‚‹ä»•æ§˜ã«ã‚‚å¼·ã„ã‚ˆğŸ’ªğŸŒ¸

```mermaid
flowchart LR
    Domain[ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤] -- "DomainError (Code)" --> Gate{ã‚¨ãƒ©ãƒ¼ç¿»è¨³}
    Gate --> API["HTTP 400 (ProblemDetails)"]
    Gate --> Log["æ§‹é€ åŒ–ãƒ­ã‚° (Error Log)"]
    Gate --> Message["ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘æ–‡è¨€"]
    
    style Gate fill:#e1f5fe,stroke:#01579b
```
---

## 6. Web APIãªã‚‰ã€ŒProblem Detailsã€ã§è¿”ã™ã®ãŒæ¨™æº–ğŸ§¾ğŸ“¦

### 6.1 Problem Detailsã£ã¦ï¼ŸğŸ§¾

HTTP APIã®ã‚¨ãƒ©ãƒ¼ã‚’ã€Œæ±ºã¾ã£ãŸå½¢ã€ã§è¿”ã™ãŸã‚ã®æ¨™æº–å½¢å¼ã ã‚ˆâœ¨
æœ€è¿‘ã¯ RFC 9457 ãŒæ­£å¼ãªä»•æ§˜ã§ã€RFC 7807 ã‚’ç½®ãæ›ãˆã¦ã‚‹ã‚ˆğŸ“˜ğŸ” ([RFC ã‚¨ãƒ‡ã‚£ã‚¿][1])

ASP.NET Core ã§ã¯ `AddProblemDetails` ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€Problem Details ã‚’ç”Ÿæˆã™ã‚‹ä»•çµ„ã¿ï¼ˆProblem details serviceï¼‰ãŒä½¿ãˆã‚‹ã‚ˆğŸ› ï¸âœ¨ ([Microsoft Learn][2])

---

### 6.2 ã¾ãšã¯ã‚¢ãƒ—ãƒªå…¨ä½“ã§Problem Detailsã‚’æœ‰åŠ¹åŒ–âœ…

æœ€å°é™ã®ä¾‹ï¼ˆWeb APIï¼‰ğŸ‘‡

```csharp
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllers();

// Problem Details ã‚’æœ‰åŠ¹åŒ–âœ¨
builder.Services.AddProblemDetails(options =>
{
    // å…¨Problem Detailsã«å…±é€šã§ãƒ¡ã‚¿æƒ…å ±ã‚’è¿½åŠ ï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹ã«ã‚‚ä¾¿åˆ©ï¼‰ğŸ§µâœ¨
    options.CustomizeProblemDetails = ctx =>
    {
        ctx.ProblemDetails.Extensions["traceId"] = ctx.HttpContext.TraceIdentifier;
        ctx.ProblemDetails.Extensions["timestamp"] = DateTimeOffset.UtcNow;
    };
});

var app = builder.Build();

app.UseExceptionHandler();  // ä¾‹å¤–ã‚’ã¾ã¨ã‚ã¦æ‰±ã†ğŸ§¯
app.UseStatusCodePages();   // 404ãªã©ã‚‚çµ±ä¸€ã—ãŸå½¢ã«ã—ã‚„ã™ã„ğŸ“„

app.MapControllers();

app.Run();
```

`CustomizeProblemDetails` ã¯å…¬å¼ã«ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºå£ã ã‚ˆğŸ§âœ¨ ([Microsoft Learn][3])
ã¾ãŸã€`AddProblemDetails` ã‚’å‘¼ã¶ã¨ã€çŠ¶æ³ã«å¿œã˜ã¦ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒ Problem Details ã‚’ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã‚ˆï¼ˆä¾‹å¤–ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãªã©ï¼‰ğŸ§© ([Microsoft Learn][2])

---

## 7. DomainError â†’ HTTPï¼ˆProblem Detailsï¼‰ã¸ã®å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ğŸ—ºï¸ğŸ”

ã€Œã©ã®ã‚¨ãƒ©ãƒ¼ã‚’ä½•HTTPã«ã™ã‚‹ï¼Ÿã€ã‚’å…ˆã«æ±ºã‚ã‚ˆã†âœ¨

| DomainError                              | HTTP Status | ã ã„ãŸã„ã®æ„å‘³        |
| ---------------------------------------- | ----------: | -------------- |
| ValidationError                          |         400 | å…¥åŠ›ãŒä¸æ­£âœï¸        |
| NotFoundError                            |         404 | å¯¾è±¡ãŒãªã„ğŸ”        |
| ConflictError                            |         409 | ç«¶åˆï¼ˆé‡è¤‡ãƒ»çŠ¶æ…‹ä¸ä¸€è‡´ï¼‰âš”ï¸ |
| ForbiddenError                           |         403 | æ¨©é™ãªã—ğŸ”’         |
| ExternalDependencyError(Retryable=true)  |         503 | ä¸€æ™‚éšœå®³ï¼ˆå†è©¦è¡Œã—ã¦ã­ï¼‰â³  |
| ExternalDependencyError(Retryable=false) |     502/500 | å¤–éƒ¨ä¾å­˜ã®å¤±æ•—ğŸŒ©ï¸     |

â€»ã“ã“ã¯â€œãƒãƒ¼ãƒ ã®æ–¹é‡â€ã§OKï¼å¤§äº‹ãªã®ã¯ **ä¸€è²«æ€§** ã ã‚ˆğŸ€âœ¨

---

## 8. å®Ÿè£…ï¼šResultã‚’è¿”ã™ã‚¢ãƒ—ãƒªå±¤ â†’ å¢ƒç•Œã§HTTPã«å¤‰æ›ğŸ§©â¡ï¸ğŸŒ

### 8.1 ä¾‹ï¼šæ³¨æ–‡ä½œæˆï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³/ã‚¢ãƒ—ãƒªå±¤ï¼‰ğŸ›’âœ¨

```csharp
using Sample.Errors;
using Sample.Results;

public sealed class OrderAppService
{
    public Result<Guid> CreateOrder(string customerId, int quantity)
    {
        // å¥‘ç´„é•åï¼ˆãƒã‚°ï¼‰ãªã‚‰ä¾‹å¤–ã§å³æ­¢ã‚ã‚‹ğŸ§¨
        if (string.IsNullOrWhiteSpace(customerId))
            throw new ArgumentException("customerId is required.", nameof(customerId));

        if (quantity <= 0)
            return Result<Guid>.Fail(new ValidationError(
                Code: "quantity.invalid",
                Message: "æ•°é‡ã¯1ä»¥ä¸Šã«ã—ã¦ã­ğŸ™‚",
                Target: "quantity"));

        // æ¥­å‹™ã‚¨ãƒ©ãƒ¼ï¼ˆä»•æ§˜ï¼‰ğŸ“©
        if (quantity > 10)
            return Result<Guid>.Fail(new ConflictError(
                Code: "order.limit_exceeded",
                Message: "ä¸€åº¦ã«æ³¨æ–‡ã§ãã‚‹ã®ã¯10å€‹ã¾ã§ã ã‚ˆğŸ€"));

        // æˆåŠŸğŸ‰
        return Result<Guid>.Ok(Guid.NewGuid());
    }
}
```

---

### 8.2 Minimal APIå´ï¼šDomainErrorã‚’Problem Detailsã«å¤‰æ›ğŸ§¾ğŸ”

```csharp
using Microsoft.AspNetCore.Mvc;
using Sample.Errors;
using Sample.Results;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddProblemDetails();
builder.Services.AddSingleton<OrderAppService>();

var app = builder.Build();

app.UseExceptionHandler();
app.UseStatusCodePages();

app.MapPost("/orders", (CreateOrderRequest req, HttpContext http, OrderAppService service) =>
{
    var result = service.CreateOrder(req.CustomerId, req.Quantity);

    return result.Match(
        onOk: id => Results.Created($"/orders/{id}", new { id }),
        onFail: err => err.ToProblemDetailsResult(http)
    );
});

app.Run();

public sealed record CreateOrderRequest(string CustomerId, int Quantity);

static class ErrorMapping
{
    public static IResult ToProblemDetailsResult(this DomainError err, HttpContext http)
    {
        var (status, type, title) = err switch
        {
            ValidationError => (StatusCodes.Status400BadRequest,
                "https://example.com/problems/validation",
                "å…¥åŠ›ãŒæ­£ã—ããªã„ã‚ˆâœï¸"),

            NotFoundError => (StatusCodes.Status404NotFound,
                "https://example.com/problems/not-found",
                "è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆğŸ”"),

            ConflictError => (StatusCodes.Status409Conflict,
                "https://example.com/problems/conflict",
                "çŠ¶æ…‹ãŒåˆã‚ãªã„ã‚ˆâš”ï¸"),

            ForbiddenError => (StatusCodes.Status403Forbidden,
                "https://example.com/problems/forbidden",
                "æ¨©é™ãŒãªã„ã‚ˆğŸ”’"),

            ExternalDependencyError ede when ede.IsRetryable => (StatusCodes.Status503ServiceUnavailable,
                "https://example.com/problems/temporary-unavailable",
                "ä»Šã¡ã‚‡ã£ã¨æ··ã‚“ã§ã‚‹ã¿ãŸã„â³"),

            _ => (StatusCodes.Status500InternalServerError,
                "https://example.com/problems/unexpected",
                "äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚ˆğŸ˜¢")
        };

        var pd = new ProblemDetails
        {
            Status = status,
            Type = type,
            Title = title,
            Detail = err.Message,
            Instance = http.Request.Path
        };

        // è¿½åŠ æƒ…å ±ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒåˆ†å²ã«ä½¿ãˆã‚‹ï¼‰ğŸ·ï¸âœ¨
        pd.Extensions["code"] = err.Code;
        pd.Extensions["retryable"] = err.IsRetryable;

        if (err is ValidationError ve && ve.Target is not null)
            pd.Extensions["target"] = ve.Target;

        return Results.Problem(pd);
    }
}
```

ã“ã“ã§ã‚„ã£ã¦ã‚‹ã“ã¨ã¯ã‚·ãƒ³ãƒ—ãƒ«ğŸ‘‡âœ¨

* ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ DomainErrorï¼ˆæ„å‘³ï¼‰ã‚’è¿”ã™ğŸ§©
* APIã¯ HTTPï¼ˆè¡¨ç¾ï¼‰ã«ç¿»è¨³ã™ã‚‹ğŸŒğŸ”
  ã“ã®åˆ†é›¢ãŒã€ã‚ã¨ã‹ã‚‰å¢—ãˆã‚‹ä»•æ§˜ã«ã‚‚å¼·ã„ã‚ˆğŸ’ªğŸŒ¸

---

## 9. ä¾‹å¤–ï¼ˆå¥‘ç´„é•åï¼‰ã‚‚â€œå¢ƒç•Œã§â€ã¡ã‚ƒã‚“ã¨Problem Detailsã«ã™ã‚‹ğŸ§¯ğŸ§¾

* ãƒ‰ãƒ¡ã‚¤ãƒ³å†…éƒ¨ã§èµ·ããŸ **å¥‘ç´„é•åï¼ˆãƒã‚°ï¼‰ä¾‹å¤–** ã¯ã€åŸºæœ¬ 500 ã«ã™ã‚‹
* **å…¥åŠ›ãƒŸã‚¹ã‚„æ¥­å‹™ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¿”ã—ãŸã„ä¾‹å¤–** ã¯ã€å¢ƒç•Œã§æ¡ã‚Šã¤ã¶ã•ãšã€Œåˆ†é¡â†’å¤‰æ›ã€ã™ã‚‹

ASP.NET Core ã«ã¯ Problem Details ã‚’ä½œã‚‹ä»•çµ„ã¿ãŒã‚ã‚Šã€`AddProblemDetails` ã§æ—¢å®šã®ã‚µãƒ¼ãƒ“ã‚¹ãŒç™»éŒ²ã•ã‚Œã‚‹ã‚ˆğŸ› ï¸âœ¨ ([Microsoft Learn][2])
ï¼ˆãªã®ã§ã€ä¾‹å¤–ã‚’ä¸¸ã”ã¨HTMLã§è¿”ã™â€¦ã¿ãŸã„ãªäº‹æ•…ãŒæ¸›ã‚‹ã‚ˆã€œğŸ§¯ï¼‰

---

## 10. ã‚ã‚ŠãŒã¡ãªå¤±æ•—ã¨ç›´ã—æ–¹ğŸ˜µâ€ğŸ’«â¡ï¸ğŸ˜Š

### å¤±æ•—â‘ ï¼šå…¨éƒ¨ Exception ã§è¿”ã—ã¡ã‚ƒã†ğŸ’¥

* å‘¼ã³å‡ºã—å´ãŒã€Œtry-catch ã ã‚‰ã‘ã€ã«ãªã£ã¦èª­ã¿ã¥ã‚‰ã„ğŸŒ€
  âœ… èµ·ãã‚‹å‰æã®ã‚‚ã®ï¼ˆæ¥­å‹™ã‚¨ãƒ©ãƒ¼ï¼‰ã¯ Result ã«å¯„ã›ã‚ˆã†ğŸâœ¨

### å¤±æ•—â‘¡ï¼šå…¨éƒ¨ Result ã«ã—ã¦â€œãƒã‚°â€ã¾ã§æ¡ã‚Šã¤ã¶ã™ğŸ™ˆ

* é‡å¤§ãƒã‚°ãŒé™ã‹ã«åŸ‹ã‚‚ã‚Œã¦ç™ºè¦‹ãŒé…ã‚Œã‚‹ğŸğŸ•³ï¸
  âœ… å¥‘ç´„é•åï¼ˆãƒã‚°ï¼‰ã¯ä¾‹å¤–ã§ fail fastğŸ§¨

### å¤±æ•—â‘¢ï¼šå†…éƒ¨æƒ…å ±ï¼ˆSQL/ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ï¼‰ã‚’å¤–ã«å‡ºã™ğŸ˜±

* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»é‹ç”¨ã®äº‹æ•…ã«ã¤ãªãŒã‚‹ã‚ˆğŸš¨
  âœ… å¤–ã«å‡ºã™ã®ã¯ã€Œåˆ©ç”¨è€…ãŒç†è§£ã§ãã‚‹æƒ…å ±ã€ã ã‘ã«ã™ã‚‹ğŸ™Šâœ¨

---

## 11. ãƒŸãƒ‹æ¼”ç¿’ï¼ˆæ‰‹ã‚’å‹•ã‹ãã†ï¼‰âœï¸ğŸ§ªâœ¨

### æ¼”ç¿’Aï¼šã‚¨ãƒ©ãƒ¼åˆ†é¡ã‚²ãƒ¼ãƒ ğŸƒğŸ§ 

æ¬¡ã®å¤±æ•—ã‚’ã€Œå¥‘ç´„é•å / æ¥­å‹™ã‚¨ãƒ©ãƒ¼ / ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã€ã«åˆ†ã‘ã¦ã¿ã¦ã­ğŸ·ï¸âœ¨

1. quantity = -1 ã‚’æ¸¡ã—ãŸ
2. åœ¨åº«ãŒ0ã ã£ãŸ
3. å¤–éƒ¨æ±ºæ¸ˆAPIãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸ
4. customerId ãŒç©ºæ–‡å­—ã ã£ãŸ
5. æ³¨æ–‡IDãŒå­˜åœ¨ã—ãªã‹ã£ãŸ

**ç­”ãˆã®ç›®å®‰**âœ…

1. æ¥­å‹™ or å¥‘ç´„ï¼ˆè¨­è¨ˆæ¬¡ç¬¬ã ã‘ã©ã€APIå…¥åŠ›ãªã‚‰æ¥­å‹™å¯„ã‚ŠãŒå¤šã„ï¼‰
2. æ¥­å‹™
3. ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå†è©¦è¡Œå¯ã«ã™ã‚‹ã“ã¨å¤šã„ï¼‰
4. å¥‘ç´„ï¼ˆä¸­ã®APIï¼‰/æ¥­å‹™ï¼ˆå¤–ã®å…¥åŠ›ï¼‰
5. æ¥­å‹™ï¼ˆNotFoundï¼‰

> ãƒã‚¤ãƒ³ãƒˆï¼šåŒã˜äº‹è±¡ã§ã‚‚ã€Œã©ã®å¢ƒç•Œã®è©±ã‹ã€ã§åˆ†é¡ãŒå¤‰ã‚ã‚‹ã‚ˆğŸšªâœ¨

---

### æ¼”ç¿’Bï¼šDomainErrorã‚’3ã¤å¢—ã‚„ã™â•ğŸ§©

* UnauthorizedErrorï¼ˆ401ç›¸å½“ï¼‰ğŸ”‘
* RateLimitErrorï¼ˆ429ç›¸å½“ï¼‰ğŸš¦
* TimeoutErrorï¼ˆå†è©¦è¡Œå¯ï¼‰â³

ãã—ã¦ `ToProblemDetailsResult` ã® switch ã«è¿½åŠ ã—ã¦ã¿ã‚ˆã†ğŸ€âœ¨

---

### æ¼”ç¿’Cï¼šãƒ†ã‚¹ãƒˆã§â€œå¤‰æ›è¡¨â€ã‚’å®ˆã‚‹ğŸ§ªğŸ›¡ï¸

ã€ŒValidationError ã¯å¿…ãš 400ã€ã¿ãŸã„ãªãƒ«ãƒ¼ãƒ«ã¯ã€ãƒ†ã‚¹ãƒˆã§å›ºå®šã™ã‚‹ã¨å®‰å¿ƒğŸ˜ŠğŸŒ¸

```csharp
using Microsoft.AspNetCore.Http;
using Sample.Errors;
using Xunit;

public class ErrorMappingTests
{
    [Fact]
    public void ValidationError_Should_Map_To_400()
    {
        var http = new DefaultHttpContext();
        http.Request.Path = "/orders";

        var err = new ValidationError("quantity.invalid", "æ•°é‡ãŒä¸æ­£", "quantity");
        var result = err.IsRetryable;

        Assert.False(result); // retryable ã¯ false ã®ã¾ã¾
        // â€» IResult ã®ä¸­èº«æ¤œè¨¼ã¯çµ±åˆãƒ†ã‚¹ãƒˆå¯„ã‚Šã«ãªã‚‹ã®ã§ã€
        //    ã¾ãšã¯ã€Œswitchã®å¤‰æ›é–¢æ•°ã€ã‚’åˆ†é›¢ã—ã¦ãƒ†ã‚¹ãƒˆã™ã‚‹ã®ãŒã‚³ãƒ„ã ã‚ˆğŸ§
    }
}
```

---

## 12. Copilot / Codex ã§çˆ†é€Ÿã«ã™ã‚‹ã‚³ãƒ„ğŸ¤–âš¡ï¸âœ¨

### ä½¿ãˆã‚‹æŒ‡ç¤ºä¾‹ï¼ˆãã®ã¾ã¾è²¼ã£ã¦OKï¼‰ğŸ“‹

* ã€ŒDomainError ã‚’ â€œValidation/NotFound/Conflict/Forbidden/ExternalDependencyâ€ ã«åˆ†ã‘ã¦ record ã§ä½œã£ã¦ã€‚Code ã¨ Message ã¨ IsRetryable ã‚’æŒãŸã›ã¦ã€ğŸ¤–ğŸ§©
* ã€ŒDomainError â†’ (status,type,title) ã‚’è¿”ã™ switch å¼ã‚’æ›¸ã„ã¦ã€‚HTTPã¯ 400/404/409/403/503/500 ã‚’ä½¿ã£ã¦ã€ğŸŒğŸ”
* ã€Œä¸Šã®å¤‰æ›è¡¨ã‚’å£Šã•ãªã„ xUnit ãƒ†ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ãƒ†ã‚¹ãƒˆã‚‚ææ¡ˆã—ã¦ã€ğŸ§ªâœ¨
* ã€ŒProblemDetails ã® extensions ã« code / retryable / target ã‚’å…¥ã‚Œã‚‹æ–¹é‡ã§å®Ÿè£…ã—ã¦ã€ğŸ§¾ğŸ·ï¸

âœ… AIã«æ›¸ã‹ã›ãŸå¾Œã¯ã“ã“ã ã‘äººãŒè¦‹ã‚‹ï¼ğŸ‘€âœ¨

* ä¾‹å¤–ã«ã™ã¹ãâ€œãƒã‚°â€ã¾ã§ Result ã«ã—ã¦ãªã„ï¼ŸğŸ§¨
* å¤–ã«å‡ºã—ã¦ã„ã„æƒ…å ±ã ã‘ã«ãªã£ã¦ã‚‹ï¼ŸğŸ™Š
* ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆCodeï¼‰ãŒãƒ–ãƒ¬ã¦ãªã„ï¼ŸğŸ·ï¸

---

## 13. ä»•ä¸Šã’ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆâœ…ğŸ€

* [ ] å¥‘ç´„é•åï¼ˆãƒã‚°ï¼‰ã¨æ¥­å‹™ã‚¨ãƒ©ãƒ¼ï¼ˆä»•æ§˜ï¼‰ãŒæ··ã–ã£ã¦ãªã„ï¼ŸğŸ§©ğŸš«
* [ ] å†è©¦è¡Œå¯/ä¸å¯ã®ãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã‚‹ï¼ŸğŸ”ğŸ·ï¸
* [ ] å¢ƒç•Œï¼ˆAPIï¼‰ã§ Problem Details ã«å¤‰æ›ã—ã¦ã‚‹ï¼ŸğŸšªğŸ§¾
* [ ] HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒä¸€è²«ã—ã¦ã‚‹ï¼ŸğŸŒğŸ“
* [ ] å†…éƒ¨æƒ…å ±ã‚’è¿”ã—ã¦ãªã„ï¼Ÿï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£OKï¼Ÿï¼‰ğŸ”’ğŸ™ˆ

---

## å‚è€ƒï¼ˆæ¨™æº–ãƒ»å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰ğŸ“šâœ¨

* Problem Details ã®æœ€æ–°ä»•æ§˜ã¯ RFC 9457ï¼ˆRFC 7807 ã‚’ç½®ãæ›ãˆï¼‰ğŸ“˜ ([RFC ã‚¨ãƒ‡ã‚£ã‚¿][1])
* ASP.NET Core ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ã¨ Problem Detailsï¼ˆ`AddProblemDetails` / `IProblemDetailsService` / ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼‰ğŸ› ï¸ ([Microsoft Learn][4])
* `CustomizeProblemDetails` ã®å…¬å¼èª¬æ˜ï¼ˆProblemDetailsOptionsï¼‰ğŸ§ ([Microsoft Learn][3])
* .NET 10 / C# 14 ã®ã€Œæœ€æ–°ä¸–ä»£ã€æƒ…å ±ï¼ˆ2025-11-11ã« .NET 10 LTS ãƒªãƒªãƒ¼ã‚¹ï¼‰ğŸ†• ([dotnet.microsoft.com][5])

[1]: https://www.rfc-editor.org/rfc/rfc9457.html?utm_source=chatgpt.com "RFC 9457: Problem Details for HTTP APIs"
[2]: https://learn.microsoft.com/en-us/aspnet/core/fundamentals/error-handling-api?view=aspnetcore-10.0 "Handle errors in ASP.NET Core APIs | Microsoft Learn"
[3]: https://learn.microsoft.com/en-us/aspnet/core/fundamentals/error-handling-api?view=aspnetcore-10.0&utm_source=chatgpt.com "Handle errors in ASP.NET Core APIs"
[4]: https://learn.microsoft.com/ja-jp/aspnet/core/fundamentals/error-handling-api?view=aspnetcore-10.0 "ASP.NET Core API ã®ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã™ã‚‹ | Microsoft Learn"
[5]: https://dotnet.microsoft.com/en-us/platform/support/policy/dotnet-core?utm_source=chatgpt.com ".NET and .NET Core official support policy | .NET"
