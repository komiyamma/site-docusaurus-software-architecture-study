# ç¬¬9ç« ï¼šVOå®Ÿè£…â‘  Emailï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæœ¬ï¼‰ğŸ“§âœ…

ã“ã®ç« ã§ã¯ã€ŒEmailã¯ã€**ä½œã‚ŒãŸæ™‚ç‚¹ã§æ­£ã—ã„**ã€ã‚’ä½“ã§è¦šãˆã¾ã™ğŸ’ªâœ¨
ï¼ˆ2026å¹´1æœˆæ™‚ç‚¹ã®æœ€æ–°ï¼š.NET 10 LTSï¼‹C# 14 å‰æã ã‚ˆã€œğŸ§ï¼‰ ([Microsoft][1])

---

## 1) ã“ã®ç« ã®ã‚´ãƒ¼ãƒ«ğŸ¯âœ¨

* å…¥åŠ›ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ã€**Emailã¨ã„ã†VO**ã«å¤‰æ›ã§ãã‚‹ğŸ“§â¡ï¸ğŸ’
* **å¤‰ãªEmailã¯â€œç”Ÿæˆã§ããªã„â€**ã‚ˆã†ã«ã§ãã‚‹ğŸš«
* å¤±æ•—ã—ãŸã¨ãã«ã€**ç†ç”±ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰**ã‚‚è¿”ã›ã‚‹ğŸ™‚ğŸ§¾

---

## 2) Emailã®æ¤œè¨¼ã£ã¦ã€å®Ÿã¯3æ®µéšã‚ã‚‹ã®ğŸ˜³ğŸ“®

Emailã£ã¦ã€Œè¦‹ãŸç›®ãŒãã‚Œã£ã½ã„ã€ã ã‘ã˜ã‚ƒè¶³ã‚Šãªã„ã“ã¨ãŒã‚ã‚‹ã‚ˆã€œğŸ’¦
ã ã„ãŸã„ã“ã‚“ãª3æ®µéšğŸ‘‡

1. **å½¢å¼ãƒã‚§ãƒƒã‚¯**ï¼ˆ`@`ãŒã‚ã‚‹ã€ç©ºç™½ãŒãªã„â€¦ãªã©ï¼‰ğŸ§¼
2. **å®Ÿåœ¨ãƒã‚§ãƒƒã‚¯**ï¼ˆDNS/MXã¨ã‹ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ï¼‰ğŸŒ
3. **åˆ°é”ãƒã‚§ãƒƒã‚¯**ï¼ˆç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ã£ã¦ã€ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚‚ã‚‰ã†ï¼‰ğŸ“©âœ…

ã“ã®ç« ã¯ã¾ãš **â‘ å½¢å¼ãƒã‚§ãƒƒã‚¯**ã ã‘ã‚„ã‚‹ã‚ˆï¼ğŸ™‚âœ¨
â€œå®Œå…¨ãªRFCæº–æ‹ â€ã‚’æ­£è¦è¡¨ç¾ã§ã‚„ã‚ã†ã¨ã™ã‚‹ã¨æ²¼ã‚Šã‚„ã™ã„ã®ã§ã€**ã‚„ã‚Šã™ããªã„**ã®ãŒã‚³ãƒ„ğŸ« ï¼ˆãƒ¡ãƒ¼ãƒ«ã®å½¢å¼ã¯ä»•æ§˜ä¸Šã‹ãªã‚Šå¹…ãŒåºƒã„ã‚ˆï¼‰ ([datatracker.ietf.org][2])

---

## 3) ä»Šå›ã®ã€Œæœ€å°ãƒ©ã‚¤ãƒ³ã€ãƒ«ãƒ¼ãƒ«ï¼ˆã‚„ã‚Šã™ããªã„ï¼‰ğŸ§âœ…

å­¦å†…ã‚«ãƒ•ã‚§æ³¨æ–‡ã‚¢ãƒ—ãƒªâ˜•ï¸ğŸ§¾ã§ã¯ã€ã¾ãšã“ã‚Œã§ååˆ†ãªã“ã¨ãŒå¤šã„ã‚ˆğŸ‘‡

* ç©ºã˜ã‚ƒãªã„ï¼ˆnull/ç©ºæ–‡å­—/ç©ºç™½ã ã‘ã¯NGï¼‰ğŸš«
* å‰å¾Œã®ç©ºç™½ã¯ãƒˆãƒªãƒ ã™ã‚‹âœ‚ï¸
* é€”ä¸­ã«ç©ºç™½ãŒå…¥ã£ã¦ãŸã‚‰NGï¼ˆ`"a b@c.com"`ã¿ãŸã„ãªã®ï¼‰ğŸš«
* ã€Œè¡¨ç¤ºåã¤ãã€ã¿ãŸã„ãªæ–‡å­—åˆ—ã¯NGï¼ˆ`"Alice <a@b.com>"`ï¼‰ğŸš«
* å½¢å¼ãƒ‘ãƒ¼ã‚¹ã¯ **`MailAddress.TryCreate`** ã‚’ä½¿ã†ï¼ˆä¾‹å¤–ã‚’æŠ•ã’ãªã„ã®ã§æ‰±ã„ã‚„ã™ã„ï¼‰âœ¨ ([Microsoft Learn][3])

---

## 4) å®Ÿè£…ï¼šEmail VOï¼ˆTryCreateãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰ğŸ’ğŸ“§

```mermaid
flowchart TD
    Input[Input String] --> Step1{Is Empty?}
    Step1 -- Yes --> Error1[Error: Empty]
    Step1 -- No --> Step2{Contains Space?}
    Step2 -- Yes --> Error2[Error: Space]
    Step2 -- No --> Step3{Format Check<br>MailAddress}
    Step3 -- NG --> Error3[Error: Format]
    Step3 -- OK --> Step4[Normalize<br>ToLower]
    Step4 --> Success[New Email ğŸ’]
```


![](./picture/entity_obj_cs_study_009_filter_funnel.png)


ãƒã‚¤ãƒ³ãƒˆã¯ã‚³ã‚³ğŸ‘‡

* **ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯éš ã™**ï¼ˆå‹æ‰‹ã«ä½œã‚Œãªã„ï¼‰ğŸ”’
* **TryCreateãŒå…¥å£**ï¼ˆã“ã“ã§æ¤œè¨¼ã—ã¦ã€OKãªã‚‰ç”Ÿæˆï¼‰ğŸšªâœ¨
* å€¤ã¯ **æ­£è¦åŒ–ï¼ˆã“ã“ã§ã¯å°æ–‡å­—åŒ–ï¼‰**ã—ã¦ãŠãã¨ã€æ¯”è¼ƒãŒãƒ©ã‚¯ğŸ§Š

```csharp
using System;
using System.Net.Mail;

namespace Cafe.Domain;

public readonly record struct Email
{
    public string Value { get; }

    private Email(string value) => Value = value;

    public override string ToString() => Value;

    // âœ… å¤±æ•—ç†ç”±ã‚‚è¿”ã›ã‚‹ TryCreate
    public static bool TryCreate(string? input, out Email email, out string error)
    {
        email = default;
        error = "";

        if (string.IsNullOrWhiteSpace(input))
        {
            error = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç©ºã ã‚ˆã€œğŸ¥º";
            return false;
        }

        var s = input.Trim();

        // ç©ºç™½æ··å…¥ã¯äº‹æ•…ã‚Šã‚„ã™ã„ã®ã§æ—©ã‚ã«å¼¾ãğŸ™‚
        if (s.Contains(' '))
        {
            error = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç©ºç™½ãŒå…¥ã£ã¦ã‚‹ã‚ˆã€œğŸ˜µ";
            return false;
        }

        // âœ… .NETã®ãƒ‘ãƒ¼ã‚µã§â€œå½¢å¼ã¨ã—ã¦â€ä½œã‚Œã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆä¾‹å¤–ãªã—ï¼‰
        if (!MailAddress.TryCreate(s, out var parsed) || parsed is null)
        {
            error = "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å½¢å¼ãŒå¤‰ã‹ã‚‚â€¦ğŸ¤”";
            return false;
        }

        // ã€ŒAlice <a@b.com>ã€ã¿ãŸã„ãªâ€œè¡¨ç¤ºåä»˜ãâ€ã¯ä»Šå›ã¯NGã«ã™ã‚‹
        if (!string.Equals(parsed.Address, s, StringComparison.OrdinalIgnoreCase))
        {
            error = "è¡¨ç¤ºåä»˜ãï¼ˆä¾‹: Alice <a@b.com>ï¼‰ã¯ä½¿ãˆãªã„ã‚ˆã€œğŸ™…â€â™€ï¸";
            return false;
        }

        // âœ¨ æ­£è¦åŒ–ï¼šå°æ–‡å­—ã«å¯„ã›ã‚‹ï¼ˆå­¦ç¿’ç”¨ã®å‰²ã‚Šåˆ‡ã‚Šï¼‰
        email = new Email(s.ToLowerInvariant());
        return true;
    }

    // âœ… â€œä½œã‚Œãªã‹ã£ãŸã‚‰ä¾‹å¤–â€ç‰ˆï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã§é›‘ã«ä½¿ã„ãŸã„ã¨ãç”¨ï¼‰
    public static Email Create(string input)
    {
        if (TryCreate(input, out var email, out var error))
            return email;

        throw new ArgumentException(error, nameof(input));
    }
}
```

`MailAddress.TryCreate` ã¯ã€Œä½œã‚Œãªã„ã¨ãã«ä¾‹å¤–ã‚’æŠ•ã’ãªã„ã€Tryç³»ãªã®ã§ã€å…¥åŠ›æ¤œè¨¼ã«å‘ã„ã¦ã‚‹ã‚ˆã€œâœ¨ ([Microsoft Learn][3])

---

## 5) ä½¿ã„æ–¹ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆæ³¨æ–‡ã®é€£çµ¡å…ˆEmailï¼‰â˜•ï¸ğŸ§¾ğŸ“§

ã€Œç”»é¢å…¥åŠ›â†’VOåŒ–â†’ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯å®‰å¿ƒã€ã£ã¦æµã‚Œã‚’ä½œã‚‹ã¨ã‚¹ãƒƒã‚­ãƒªã™ã‚‹ã‚ˆâœ¨

```csharp
using Cafe.Domain;

public static class CreateOrderUseCase
{
    public static void Execute(string emailText)
    {
        if (!Email.TryCreate(emailText, out var email, out var error))
        {
            // UIã«å„ªã—ãè¿”ã™ï¼ˆã“ã“ã§ã¯Consoleã§ä»£ç”¨ï¼‰
            Console.WriteLine(error);
            return;
        }

        // ã“ã“ã‹ã‚‰å…ˆã¯ã€ŒEmailã¯æ­£ã—ã„ã€å‰æã§é€²ã‚ã‚‰ã‚Œã‚‹âœ¨
        Console.WriteLine($"æ³¨æ–‡è€…ãƒ¡ãƒ¼ãƒ«: {email}");
    }
}
```

---

## 6) ãƒ†ã‚¹ãƒˆï¼ˆxUnitï¼‰ğŸ§ªâœ¨

ã€Œç„¡åŠ¹ãªEmailã¯ä½œã‚Œãªã„ã€ã‚’ãƒ†ã‚¹ãƒˆã§å®ˆã‚‹ã®ãŒVOã®æ°—æŒã¡ã‚ˆã•ğŸ’

```csharp
using Xunit;
using Cafe.Domain;

public class EmailTests
{
    [Theory]
    [InlineData("a@b.com", "a@b.com")]
    [InlineData(" USER@Example.com ", "user@example.com")]
    [InlineData("user.name+tag@sub.example.ac.jp", "user.name+tag@sub.example.ac.jp")]
    public void TryCreate_Valid_ReturnsTrue(string input, string expected)
    {
        var ok = Email.TryCreate(input, out var email, out var error);

        Assert.True(ok, error);
        Assert.Equal(expected, email.Value);
    }

    [Theory]
    [InlineData(null)]
    [InlineData("")]
    [InlineData("   ")]
    [InlineData("a@")]
    [InlineData("@b.com")]
    [InlineData("a b@c.com")]
    [InlineData("Alice <a@b.com>")]
    public void TryCreate_Invalid_ReturnsFalse(string? input)
    {
        var ok = Email.TryCreate(input, out _, out var error);

        Assert.False(ok);
        Assert.False(string.IsNullOrWhiteSpace(error));
    }

    [Fact]
    public void Equality_IsCaseInsensitive_ByNormalization()
    {
        Email.TryCreate("USER@EXAMPLE.COM", out var e1, out _);
        Email.TryCreate("user@example.com", out var e2, out _);

        Assert.Equal(e1, e2);
    }
}
```

---

## 7) ãƒŸãƒ‹æ¼”ç¿’ï¼ˆ10ã€œ15åˆ†ï¼‰âœï¸â±ï¸âœ¨

1. `Email.TryCreate("a@b.com")` ãŒæˆåŠŸã™ã‚‹ã®ã‚’ç¢ºèªğŸ“§âœ…
2. `Email.TryCreate("Alice <a@b.com>")` ãŒå¤±æ•—ã™ã‚‹ã®ã‚’ç¢ºèªğŸ™…â€â™€ï¸
3. NGã‚±ãƒ¼ã‚¹ã‚’ **5å€‹è¿½åŠ **ã—ã¦ãƒ†ã‚¹ãƒˆã«å…¥ã‚Œã‚‹ğŸ§ªâœ¨

   * ä¾‹ï¼š`"a@b..com"`ã€`"a@b,com"`ã€`"a@@b.com"`ã€`"a@b.com "`ã€`" a@b.com"` ãªã©ğŸ™‚

---

## 8) AIæ´»ç”¨ï¼ˆCopilot/Codexæƒ³å®šï¼‰ğŸ¤–âœ¨ï¼šæœ€çŸ­ã§ç²¾åº¦ã‚’ä¸Šã’ã‚‹ã‚³ãƒ„

ãã®ã¾ã¾è²¼ã£ã¦ä½¿ãˆã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹ã ã‚ˆğŸ‘‡ğŸ’•

* ã€ŒC# 14ã§ Email ã® Value Object ã‚’ `readonly record struct` ã§ä½œã£ã¦ã€‚`TryCreate` ã§ã‚¨ãƒ©ãƒ¼æ–‡å­—åˆ—ã‚‚è¿”ã—ã¦ã€‚`MailAddress.TryCreate` ã‚’ä½¿ã£ã¦ã€`Alice <a@b.com>` ã¯å¼¾ã„ã¦ã€‚xUnit ãƒ†ã‚¹ãƒˆã‚‚ä¸€ç·’ã«ã€
* ã€ŒEmailã®NGãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’20å€‹ã€ç¾å®Ÿã§èµ·ããŒã¡ãªã‚„ã¤ä¸­å¿ƒã§ææ¡ˆã—ã¦ã€

âœ… AIã®å‡ºåŠ›ã‚’è¦‹ãŸã‚‰ã€ã“ã“ã ã‘ã¯ç›®è¦–ãƒã‚§ãƒƒã‚¯ã—ã¦ã­ğŸ‘€

* **ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒpublicã«ãªã£ã¦ãªã„ï¼Ÿ**ï¼ˆå‹æ‰‹ã«ä½œã‚Œã¦å´©ã‚Œã‚‹ï¼‰ğŸ”’
* **æ­£è¦è¡¨ç¾ã‚´ãƒªã‚´ãƒª**ã«ãªã£ã¦ãªã„ï¼Ÿï¼ˆã‚„ã‚Šã™ãï¼‰ğŸ« 
* **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé›‘**ã™ããªã„ï¼Ÿï¼ˆUIã«å‡ºã™ã¨ã¤ã‚‰ã„ï¼‰ğŸ¥º

---

## 9) ã‚ˆãã‚ã‚‹è½ã¨ã—ç©´ğŸ˜µâ€ğŸ’«ğŸ’¥ï¼ˆå…ˆã«æ½°ãï¼ï¼‰

* ã€ŒRFCã«å®Œå…¨æº–æ‹ ã™ã‚‹æ­£è¦è¡¨ç¾ã€ã‚’ç›®æŒ‡ã—ã¦æ™‚é–“ãŒæº¶ã‘ã‚‹ğŸ« ï¼ˆä»•æ§˜ã¯åºƒã„ã‚ˆï¼‰ ([datatracker.ietf.org][2])
* `EmailAddressAttribute` ã ã‘ã§â€œå®Œå…¨ã«å®‰å¿ƒâ€ã¨æ€ã„è¾¼ã‚€ï¼ˆç”¨é€”ã¯ä¸»ã«å…¥åŠ›æ³¨é‡ˆå¯„ã‚Šã€‚å®Ÿè£…ã¯å¤‰ã‚ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ï¼‰ğŸ“Œ ([Microsoft Learn][4])
* â€œåˆ°é”ã™ã‚‹ã‹â€ã¾ã§å½¢å¼ãƒã‚§ãƒƒã‚¯ã§ä¿è¨¼ã—ã‚ˆã†ã¨ã™ã‚‹ï¼ˆãã‚Œã¯ç¢ºèªãƒ¡ãƒ¼ãƒ«ã®é ˜åŸŸï¼‰ğŸ“©âœ…

---

## ã¾ã¨ã‚ğŸ€âœ¨

* Emailã¯ã¾ãš **ã€Œä½œã‚ŒãŸæ™‚ç‚¹ã§æ­£ã—ã„ã€VO**ã«ã™ã‚‹ğŸ“§ğŸ’
* æ¤œè¨¼ã¯ **æœ€å°ãƒ©ã‚¤ãƒ³ã§OK**ï¼ˆã‚„ã‚Šã™ããªã„ï¼‰ğŸ™‚
* `TryCreate`ï¼‹ãƒ†ã‚¹ãƒˆã§ã€å…¥åŠ›åœ°ç„ã‚’å…¥å£ã§æ­¢ã‚ã‚‹ğŸ§±ğŸ§ª
* æ¬¡ã®ç« ï¼ˆMoneyï¼‰ã§ã‚‚åŒã˜å‹ã®è€ƒãˆæ–¹ã§ã„ã‘ã‚‹ã‚ˆã€œï¼ğŸ’°âœ¨

å¿…è¦ãªã‚‰ã€ã“ã®Email VOã‚’ **Orderï¼ˆæ³¨æ–‡ï¼‰ã«çµ„ã¿è¾¼ã‚€ã¨ã“ã‚**ã¾ã§ä¸€æ°—ã«â€œç« ã®ç¶šãâ€ã¨ã—ã¦æ›¸ãã‚ˆã€œâ˜•ï¸ğŸ§¾ğŸ’ª

[1]: https://dotnet.microsoft.com/en-US/download/dotnet/10.0?utm_source=chatgpt.com "Download .NET 10.0 (Linux, macOS, and Windows) | .NET"
[2]: https://datatracker.ietf.org/doc/html/rfc5322?utm_source=chatgpt.com "RFC 5322 - Internet Message Format - Datatracker - IETF"
[3]: https://learn.microsoft.com/en-us/dotnet/api/system.net.mail.mailaddress.trycreate?view=net-10.0&utm_source=chatgpt.com "MailAddress.TryCreate Method (System.Net.Mail)"
[4]: https://learn.microsoft.com/en-us/dotnet/api/system.componentmodel.dataannotations.emailaddressattribute?view=net-10.0&utm_source=chatgpt.com "EmailAddressAttribute Class (System.ComponentModel. ..."
